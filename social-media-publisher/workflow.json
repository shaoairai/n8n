{
  "name": "ç¤¾ç¾¤åª’é«”ç™¼æ–‡ (FB + IG)",
  "nodes": [
    {
      "parameters": {},
      "id": "node-manual-trigger",
      "name": "æ‰‹å‹•è§¸ç™¼",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [0, 300]
    },
    {
      "parameters": {
        "operation": "read",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "={{ $env.SOCIAL_SHEET_ID }}"
        },
        "sheetName": {
          "__rl": true,
          "mode": "name",
          "value": "ç¤¾ç¾¤ç™¼æ–‡"
        },
        "options": {}
      },
      "id": "node-read-gsheet",
      "name": "è®€å– Google Sheets",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [220, 300],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "gsheet-credential",
          "name": "Google Sheets"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ç¯©é¸ç•¶æ—¥å¾…ç™¼å¸ƒçš„é …ç›®\nconst items = $input.all();\nconst today = new Date();\nconst todayStr = today.toISOString().split('T')[0]; // YYYY-MM-DD\n\nconst results = [];\n\nfor (const item of items) {\n  const data = item.json;\n  \n  // ç‹€æ…‹å¿…é ˆæ˜¯ã€Œå¾…ç™¼å¸ƒã€\n  if (data['ç‹€æ…‹'] !== 'å¾…ç™¼å¸ƒ') continue;\n  \n  // æª¢æŸ¥é å®šæ™‚é–“æ˜¯å¦ç‚ºç•¶æ—¥\n  if (data['é å®šæ™‚é–“']) {\n    const timeStr = data['é å®šæ™‚é–“'].replace(/\\//g, '-');\n    const scheduledDate = timeStr.split(' ')[0]; // å–æ—¥æœŸéƒ¨åˆ†\n    if (scheduledDate !== todayStr) continue;\n  }\n  \n  results.push({ json: data });\n}\n\n// åªå–ç¬¬ä¸€ç­†\nreturn results.length > 0 ? [results[0]] : [];"
      },
      "id": "node-filter-today",
      "name": "ç¯©é¸ç•¶æ—¥å¾…ç™¼å¸ƒ",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [440, 300]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "conditions": [
            {
              "id": "check-has-data",
              "leftValue": "={{ $json['åœ–ç‰‡ç¶²å€'] }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "node-check-data",
      "name": "æª¢æŸ¥æœ‰è³‡æ–™",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [660, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v21.0/{{ $env.FB_PAGE_ID }}/photos",
        "authentication": "genericCredentialType",
        "genericAuthType": "oAuth2Api",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"url\": \"{{ $json['åœ–ç‰‡ç¶²å€'] }}\",\n  \"message\": \"{{ $json['FBå…§æ–‡'] }}\",\n  \"published\": true\n}",
        "options": { "timeout": 60000 }
      },
      "id": "node-fb-post",
      "name": "ç™¼æ–‡åˆ° FB",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [880, 200],
      "credentials": {
        "oAuth2Api": {
          "id": "fb-oauth-credential",
          "name": "Facebook Graph API"
        }
      },
      "onError": "continueErrorOutput",
      "retryOnFail": true,
      "maxTries": 2,
      "waitBetweenTries": 5000
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v21.0/{{ $env.IG_BUSINESS_ACCOUNT_ID }}/media",
        "authentication": "genericCredentialType",
        "genericAuthType": "oAuth2Api",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"image_url\": \"{{ $json['åœ–ç‰‡ç¶²å€'] }}\",\n  \"caption\": \"{{ $json['IGå…§æ–‡'] }}\"\n}",
        "options": { "timeout": 60000 }
      },
      "id": "node-ig-container",
      "name": "IG å»ºç«‹å®¹å™¨",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [880, 400],
      "credentials": {
        "oAuth2Api": {
          "id": "fb-oauth-credential",
          "name": "Facebook Graph API"
        }
      },
      "onError": "continueErrorOutput",
      "retryOnFail": true,
      "maxTries": 2,
      "waitBetweenTries": 5000
    },
    {
      "parameters": {
        "jsCode": "// è™•ç† FB çµæœä¸¦ä¿ç•™åŸå§‹è³‡æ–™\nconst original = $('ç¯©é¸ç•¶æ—¥å¾…ç™¼å¸ƒ').first().json;\nconst fb = $input.first().json;\n\nreturn [{\n  json: {\n    ...original,\n    fb_success: !!(fb.id || fb.post_id),\n    fb_post_id: fb.id || fb.post_id || null,\n    fb_error: fb.error?.message || null\n  }\n}];"
      },
      "id": "node-fb-result",
      "name": "FB çµæœ",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1100, 200]
    },
    {
      "parameters": {
        "jsCode": "// è™•ç† IG å®¹å™¨çµæœ\nconst original = $('ç¯©é¸ç•¶æ—¥å¾…ç™¼å¸ƒ').first().json;\nconst container = $input.first().json;\n\nconst hasContainer = !!container.id;\n\nreturn [{\n  json: {\n    ...original,\n    ig_container_id: container.id || null,\n    ig_error: container.error?.message || null,\n    ig_has_container: hasContainer\n  }\n}];"
      },
      "id": "node-ig-container-result",
      "name": "IG å®¹å™¨çµæœ",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1100, 400]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "conditions": [
            {
              "id": "check-container",
              "leftValue": "={{ $json.ig_has_container }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "node-ig-check",
      "name": "IG å®¹å™¨æˆåŠŸï¼Ÿ",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1320, 400]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v21.0/{{ $env.IG_BUSINESS_ACCOUNT_ID }}/media_publish",
        "authentication": "genericCredentialType",
        "genericAuthType": "oAuth2Api",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"creation_id\": \"{{ $json.ig_container_id }}\"\n}",
        "options": { "timeout": 60000 }
      },
      "id": "node-ig-publish",
      "name": "IG ç™¼å¸ƒ",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1540, 300],
      "credentials": {
        "oAuth2Api": {
          "id": "fb-oauth-credential",
          "name": "Facebook Graph API"
        }
      },
      "onError": "continueErrorOutput",
      "retryOnFail": true,
      "maxTries": 2,
      "waitBetweenTries": 5000
    },
    {
      "parameters": {
        "jsCode": "// IG ç™¼å¸ƒçµæœ\nconst prev = $('IG å®¹å™¨çµæœ').first().json;\nconst publish = $input.first().json;\n\nreturn [{\n  json: {\n    ...prev,\n    ig_success: !!publish.id,\n    ig_post_id: publish.id || null,\n    ig_error: publish.error?.message || prev.ig_error\n  }\n}];"
      },
      "id": "node-ig-result",
      "name": "IG ç™¼å¸ƒçµæœ",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1760, 300]
    },
    {
      "parameters": {
        "jsCode": "// IG å®¹å™¨å¤±æ•—\nconst prev = $input.first().json;\n\nreturn [{\n  json: {\n    ...prev,\n    ig_success: false,\n    ig_post_id: null\n  }\n}];"
      },
      "id": "node-ig-failed",
      "name": "IG å¤±æ•—",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1540, 500]
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "id": "node-merge",
      "name": "åˆä½µçµæœ",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [1980, 300]
    },
    {
      "parameters": {
        "jsCode": "// æ•´åˆæœ€çµ‚çµæœ\nconst items = $input.all();\n\nlet fbData = items.find(i => i.json.fb_success !== undefined)?.json;\nlet igData = items.find(i => i.json.ig_success !== undefined)?.json;\nlet original = fbData || igData;\n\nconst fb_success = fbData?.fb_success || false;\nconst ig_success = igData?.ig_success || false;\n\nconst now = new Date().toLocaleString('zh-TW', {\n  timeZone: 'Asia/Taipei',\n  year: 'numeric', month: '2-digit', day: '2-digit',\n  hour: '2-digit', minute: '2-digit', hour12: false\n}).replace(/\\//g, '-');\n\nreturn [{\n  json: {\n    keyword: original?.['é—œéµå­—'] || '',\n    ç‹€æ…‹: (fb_success && ig_success) ? 'å·²ç™¼å¸ƒ' : 'éƒ¨åˆ†å¤±æ•—',\n    ç™¼å¸ƒæ™‚é–“: now,\n    all_success: fb_success && ig_success,\n    fb: { success: fb_success, id: fbData?.fb_post_id, error: fbData?.fb_error, text: original?.['FBå…§æ–‡'] },\n    ig: { success: ig_success, id: igData?.ig_post_id, error: igData?.ig_error, text: original?.['IGå…§æ–‡'] },\n    image: original?.['åœ–ç‰‡ç¶²å€']\n  }\n}];"
      },
      "id": "node-final",
      "name": "æ•´ç†çµæœ",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2200, 300]
    },
    {
      "parameters": {
        "operation": "appendOrUpdate",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "={{ $env.SOCIAL_SHEET_ID }}"
        },
        "sheetName": {
          "__rl": true,
          "mode": "name",
          "value": "ç¤¾ç¾¤ç™¼æ–‡"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "é—œéµå­—": "={{ $json.keyword }}",
            "ç‹€æ…‹": "={{ $json['ç‹€æ…‹'] }}",
            "ç™¼å¸ƒæ™‚é–“": "={{ $json['ç™¼å¸ƒæ™‚é–“'] }}"
          }
        },
        "matchingColumns": ["é—œéµå­—"],
        "options": { "cellFormat": "USER_ENTERED" }
      },
      "id": "node-update-sheet",
      "name": "å›å¡«ç‹€æ…‹",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [2420, 300],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "gsheet-credential",
          "name": "Google Sheets"
        }
      }
    },
    {
      "parameters": {
        "sendTo": "={{ $env.NOTIFY_EMAIL }}",
        "subject": "=ç¤¾ç¾¤ç™¼æ–‡ {{ $json.all_success ? 'æˆåŠŸ' : 'éƒ¨åˆ†å¤±æ•—' }} - {{ $json['ç™¼å¸ƒæ™‚é–“'] }}",
        "emailType": "text",
        "message": "=ç¤¾ç¾¤ç™¼æ–‡çµæœ\n==============\n\nğŸ“˜ Facebook: {{ $json.fb.success ? 'âœ… æˆåŠŸ (ID: ' + $json.fb.id + ')' : 'âŒ å¤±æ•— - ' + $json.fb.error }}\nğŸ“· Instagram: {{ $json.ig.success ? 'âœ… æˆåŠŸ (ID: ' + $json.ig.id + ')' : 'âŒ å¤±æ•— - ' + $json.ig.error }}\n\nåœ–ç‰‡: {{ $json.image }}"
      },
      "id": "node-email",
      "name": "å¯„é€é€šçŸ¥",
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2.1,
      "position": [2640, 300],
      "credentials": {
        "smtp": {
          "id": "smtp-credential",
          "name": "SMTP"
        }
      }
    },
    {
      "parameters": {},
      "id": "node-error-trigger",
      "name": "éŒ¯èª¤è§¸ç™¼",
      "type": "n8n-nodes-base.errorTrigger",
      "typeVersion": 1,
      "position": [0, 600]
    },
    {
      "parameters": {
        "sendTo": "={{ $env.NOTIFY_EMAIL }}",
        "subject": "=ç¤¾ç¾¤ç™¼æ–‡éŒ¯èª¤ - {{ $now.setZone('Asia/Taipei').toFormat('MM-dd HH:mm') }}",
        "emailType": "text",
        "message": "=å·¥ä½œæµç¨‹éŒ¯èª¤ï¼\n\néŒ¯èª¤ï¼š{{ $json.execution.error.message }}\nç¯€é»ï¼š{{ $json.execution.lastNodeExecuted }}"
      },
      "id": "node-error-email",
      "name": "éŒ¯èª¤é€šçŸ¥",
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2.1,
      "position": [220, 600],
      "credentials": {
        "smtp": {
          "id": "smtp-credential",
          "name": "SMTP"
        }
      }
    }
  ],
  "connections": {
    "æ‰‹å‹•è§¸ç™¼": {
      "main": [[{ "node": "è®€å– Google Sheets", "type": "main", "index": 0 }]]
    },
    "è®€å– Google Sheets": {
      "main": [[{ "node": "ç¯©é¸ç•¶æ—¥å¾…ç™¼å¸ƒ", "type": "main", "index": 0 }]]
    },
    "ç¯©é¸ç•¶æ—¥å¾…ç™¼å¸ƒ": {
      "main": [[{ "node": "æª¢æŸ¥æœ‰è³‡æ–™", "type": "main", "index": 0 }]]
    },
    "æª¢æŸ¥æœ‰è³‡æ–™": {
      "main": [
        [
          { "node": "ç™¼æ–‡åˆ° FB", "type": "main", "index": 0 },
          { "node": "IG å»ºç«‹å®¹å™¨", "type": "main", "index": 0 }
        ],
        []
      ]
    },
    "ç™¼æ–‡åˆ° FB": {
      "main": [[{ "node": "FB çµæœ", "type": "main", "index": 0 }]]
    },
    "IG å»ºç«‹å®¹å™¨": {
      "main": [[{ "node": "IG å®¹å™¨çµæœ", "type": "main", "index": 0 }]]
    },
    "FB çµæœ": {
      "main": [[{ "node": "åˆä½µçµæœ", "type": "main", "index": 0 }]]
    },
    "IG å®¹å™¨çµæœ": {
      "main": [[{ "node": "IG å®¹å™¨æˆåŠŸï¼Ÿ", "type": "main", "index": 0 }]]
    },
    "IG å®¹å™¨æˆåŠŸï¼Ÿ": {
      "main": [
        [{ "node": "IG ç™¼å¸ƒ", "type": "main", "index": 0 }],
        [{ "node": "IG å¤±æ•—", "type": "main", "index": 0 }]
      ]
    },
    "IG ç™¼å¸ƒ": {
      "main": [[{ "node": "IG ç™¼å¸ƒçµæœ", "type": "main", "index": 0 }]]
    },
    "IG ç™¼å¸ƒçµæœ": {
      "main": [[{ "node": "åˆä½µçµæœ", "type": "main", "index": 1 }]]
    },
    "IG å¤±æ•—": {
      "main": [[{ "node": "åˆä½µçµæœ", "type": "main", "index": 1 }]]
    },
    "åˆä½µçµæœ": {
      "main": [[{ "node": "æ•´ç†çµæœ", "type": "main", "index": 0 }]]
    },
    "æ•´ç†çµæœ": {
      "main": [[{ "node": "å›å¡«ç‹€æ…‹", "type": "main", "index": 0 }]]
    },
    "å›å¡«ç‹€æ…‹": {
      "main": [[{ "node": "å¯„é€é€šçŸ¥", "type": "main", "index": 0 }]]
    },
    "éŒ¯èª¤è§¸ç™¼": {
      "main": [[{ "node": "éŒ¯èª¤é€šçŸ¥", "type": "main", "index": 0 }]]
    }
  },
  "settings": {
    "executionOrder": "v1"
  }
}
